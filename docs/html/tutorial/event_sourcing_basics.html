
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<meta name="HandheldFriendly" content="True"/>
<title>Event Sourcing Basics</title>
<link rel="shortcut icon" href="http://getprooph.org/images/ico/prooph-logo@0.5x.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://getprooph.org/images/ico/apple-touch-icon-144-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://getprooph.org/images/ico/apple-touch-icon-114-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://getprooph.org/images/ico/apple-touch-icon-72-precomposed.png">
<link rel="apple-touch-icon-precomposed" href="http://getprooph.org/images/ico/apple-touch-icon-57-precomposed.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@prooph_software">
<meta name="twitter:title" content="prooph components">
<meta name="twitter:description" content="Enterprise-ready CQRS and Event Sourcing packages for PHP with support for the most famous PHP web frameworks">
<meta name="twitter:image" content="http://getprooph.org/images/prooph-components-intro.png">
    <link rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/cerulean/bootstrap.min.css">
<link rel="stylesheet"
      href="https://tobiju.github.io/share/prismjs/prism-ghcolors.css"/>
<link rel="stylesheet"
      href="https://tobiju.github.io/share/prismjs/prism-linenumbers.css"/>
<style>
    body, html {
        height: 100%;
        padding-top: 36px;
        position: relative;
    }

    img {
        max-width: 100%;
    }

    code span {
        white-space: nowrap;
    }
    code span.comment {
        white-space: pre;
    }

    .highlight {
        background: #FFFF88;
    }

    .page-wrapper {
        min-height: 100%;
        padding-bottom: 170px;
        position: relative;
    }

    .box-header {
        position: relative;
    }

    /* Header Section */
    header {
        background: white;
        color: black;
        font-size: 16px;
        font-weight: 300;
    }

    h1:first-child {
        margin-top: 0;
    }

    /* anchor link will be displayed after the static top nav */
    h1:before,
    h2:before,
    h3:before,
    h4:before,
    h5:before,
    h6:before {
        display: block;
        content: " ";
        margin-top: -64px;
        height: 64px;
        visibility: hidden;
    }

    .navbar-brand {
        padding: 0;
    }

    .navbar-brand img {
        max-height: 100%;
    }

    /* Content Section */
    #content {
        margin-bottom: 17px;
        font-size: 17px;
        min-height: 200px;
    }

    .breadcrumb {
        position: relative;
        z-index: 999;
    }

    .links {
        background: #f8f8f8;
        border-top: 1px solid #e5e5e5;
        border-bottom: 1px solid #e5e5e5;
        padding: 16px 0;
    }

    .links .prev {
        text-align: left;
    }

    .links .parent {
        text-align: center;
    }

    .links .next {
        text-align: right;
    }

    /* Search */
    .form-search {
        position: absolute;
        right: 0;
        top: 0;
        z-index: 999;
    }

    @media (max-width: 767px) {
        .form-search {
            position: relative;
            margin-top: 0;
        }
    }

    .form-search .form-control {
        border: 0;
        width: 80px;
    }

    @media (max-width: 767px) {
        .form-search .form-control {
            width: 100% !important;
        }
    }

    .form-search .list-search-results {
        position: relative;
    }

    .form-search .list-search-results ul {
        background: #eee;
        border: 1px solid inherit;
        list-style: none;
        max-height: 300px;
        overflow: auto;
        padding: 0;
        position: absolute;
        width: 100%;
        z-index: 999;
    }

    .form-search .list-search-results ul li:nth-child(even) {
        background: rgba(255, 255, 255, 0.3)
    }

    .form-search .list-search-results ul li.selected {
        background: #ccc;
    }

    .form-search .list-search-results ul li a {
        display: block;
        padding: 4px 8px;
    }

    /* TOC */
    .list-toc {
        padding: 0;
    }

    .list-toc .list-group-item {
        background: 0 none;
        position: relative;
        font-weight: bold;
        padding: 0;
        margin: 0;
    }

    .list-toc li .text-number {
        padding-left: 20px;
    }
    .list-toc li li .text-number {
        padding-left: 40px;
    }
    .list-toc li li li .text-number {
        padding-left: 60px;
    }
    .list-toc li li li li .text-number {
        padding-left: 80px;
    }
    .list-toc li li li li li .text-number {
        padding-left: 100px;
    }
    .list-toc .text-number {
        padding-left: 100px;
    }

    .list-toc .list-group-item .row {
        padding: 7px 0 7px;
    }

    .list-toc .list-group-item .bbt-toc-toggle {
        display: block;
        position: absolute;
        top: 5px;
        right: 10px;
        font-weight: normal;
    }

    .list-toc .list-group-item .bbt-toc-toggle:before {
        content: "";
        display: block;
    }

    .list-toc .list-group-item .bbt-toc-toggle.collapsed:before {
        content: "";
        display: block;
    }

    .list-toc > li:nth-child(2n+1) {
        background: rgba(0, 0, 0, 0.03);
    }

    .bbt-theme-cyborg .list-toc > li:nth-child(2n+1),
    .bbt-theme-darkly .list-toc > li:nth-child(2n+1),
    .bbt-theme-slate .list-toc > li:nth-child(2n+1),
    .bbt-theme-superhero .list-toc > li:nth-child(2n+1) {
        background: rgba(255, 255, 255, 0.05);
    }

    .list-toc .list-group-item {
        border-bottom: 0 none;
        border-left: 0 none;
        border-right: 0 none;
        font-size: inherit;
    }

    .list-toc .list-group-item:first-child {
        border-top-right-radius: 0;
        border-top-left-radius: 0;
    }

    .list-toc .list-group-item:last-child {
        border-bottom-right-radius: 0;
        border-bottom-left-radius: 0;
    }

    /* Left navigation */
    .nav-left ul li a {
        padding-top: 3px;
        padding-bottom: 3px;
        border-left: 1px solid transparent;
    }

    .nav-left ul li.active a,
    .nav-left ul li a:hover {
        background: none !important;
        color: inherit;
        border-color: inherit;
    }

    .navbar-top {
        position: relative;
    }

    .affix {
        top: 60px;
    }

    .badge {
        border-radius: 4px;
        padding: 5px;
    }

    /* Footer Section */
    footer {
        color: black;
        background: white;
        width: 100%;
        position: absolute;
        bottom: 0;
    }

    footer #copyright {
        padding: 30px;
        text-align: center;
        color: #444;
    }

    footer #copyright p {
        margin: 0;
    }

    footer #copyright span a {
        color: white;
    }

    /* Top Navigation */
    @media (max-width: 767px) {
        ul.navbar-nav {
            margin: 0 -15px
        }

        ul.navbar-nav li {
            border-radius: 0;
        }

        ul.navbar-nav li ul {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 0;
            box-shadow: none;
            display: block;
            float: none;
            left: auto;
            padding: 0;
            position: static;
        }

        ul.navbar-nav li ul li a {
            padding: 8px 30px;
        }

        ul.navbar-nav li ul li ul li a {
            padding: 6px 40px;
        }
    }

    @media (min-width: 768px) {

        ul.navbar-nav li {
            display: block;
            position: relative;
            float: left;
        }

        ul.navbar-nav li ul {
            display: none;
        }

        ul.navbar-nav li a {
            display: block;
        }

        ul.navbar-nav li:hover > ul {
            display: block;
            position: absolute;
        }

        ul.navbar-nav li:hover li {
            float: none;
        }

        ul.navbar-nav ul ul {
            left: 100%;
            top: 0;
        }
    }
</style>
    <style>
    .prooph-logo {
            float: left;
            margin-left: 8px;
            margin-right: 8px;
            transition-timing-function: ease-in-out;
            transition: all 5s;
            height: 50px;
            padding: 5px;
        }

        .prooph-logo:hover {
            transition: all .7s;
            transition-timing-function: ease-out;
            transform: rotate(360deg);
        }
</style>
</head>
<body data-spy="scroll" data-target="#sideNav" data-offset="50" class="bbt-theme-cerulean">
<div class="page-wrapper">
    <header>
    
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="box-header container">
        <form class="form-search navbar-form navbar-right" role="search">
            <div class="form-group">
                <input type="text"
                       placeholder="Search"
                       class="js-search-input form-control"
                       data-roothref="/">

                <div class="js-search-results"></div>
            </div>
        </form>

        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#js-navbar-collapse" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://getprooph.org">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" class="prooph-logo">
                    <defs>
                        <style>
                            .cls-1{fill:#04a1b0;}.cls-2{fill:#26896c;}.cls-3{fill:#eeca50;}.cls-4{fill:#eb6842;}.cls-5{fill:#cc3340;}.cls-6{fill:#715671;}
                        </style>
                    </defs>
                    <title>prooph-logo</title>
                    <g id="artwork">
                        <g id="Layer_5" data-name="Layer 5">
                            <path class="cls-1"
                                  d="M57.22,17,67.84,35.43a1.77,1.77,0,0,0,1.53.89h61.25a1.77,1.77,0,0,0,1.53-.89L142.78,17a1.77,1.77,0,0,0-1.53-2.66H58.76A1.77,1.77,0,0,0,57.22,17Z"/>
                            <path class="cls-2"
                                  d="M29.54,94.68l30.63-53a1.77,1.77,0,0,0,0-1.77L49.55,21.48a1.77,1.77,0,0,0-3.07,0L5.24,92.91a1.77,1.77,0,0,0,1.53,2.66H28A1.77,1.77,0,0,0,29.54,94.68Z"/>
                            <path class="cls-3"
                                  d="M60.16,158.36l-30.63-53a1.77,1.77,0,0,0-1.53-.89H6.78a1.77,1.77,0,0,0-1.53,2.66l41.24,71.43a1.77,1.77,0,0,0,3.07,0l10.61-18.38A1.77,1.77,0,0,0,60.16,158.36Z"/>
                            <path class="cls-4"
                                  d="M130.63,163.68H69.37a1.77,1.77,0,0,0-1.53.89L57.22,183a1.77,1.77,0,0,0,1.53,2.66h82.48a1.77,1.77,0,0,0,1.53-2.66l-10.61-18.38A1.77,1.77,0,0,0,130.63,163.68Z"/>
                            <path class="cls-5"
                                  d="M170.46,105.32l-30.63,53a1.77,1.77,0,0,0,0,1.77l10.61,18.38a1.77,1.77,0,0,0,3.07,0l41.24-71.43a1.77,1.77,0,0,0-1.53-2.66H172A1.77,1.77,0,0,0,170.46,105.32Z"/>
                            <path class="cls-6"
                                  d="M139.84,41.64l30.63,53a1.77,1.77,0,0,0,1.53.89h21.23a1.77,1.77,0,0,0,1.53-2.66L153.52,21.48a1.77,1.77,0,0,0-3.07,0L139.84,39.86A1.77,1.77,0,0,0,139.84,41.64Z"/>
                        </g>
                    </g>
                </svg>
            </a>

        </div>

        <div class="collapse navbar-collapse" id="js-navbar-collapse">
            
    
    <ul class="nav navbar-nav">
                        <li>
    <a href="/tutorial/">Tutorial</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/tutorial/introduction.html">Introduction</a>

    </li>
                        <li>
    <a href="/tutorial/why_event_sourcing.html">Why Event Sourcing?</a>

    </li>
                        <li>
    <a href="/tutorial/event_sourcing_basics.html">Event Sourcing Basics</a>

    </li>
                        <li>
    <a href="/tutorial/testing_aggregates.html">Testing Aggregates</a>

    </li>
                        <li>
    <a href="/tutorial/aggregate_dependencies.html">Aggregate Dependencies</a>

    </li>
                        <li>
    <a href="/tutorial/process_managers.html">Process Managers</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/event-sourcing/">Event Sourcing</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/event-sourcing/intro.html">ProophEventSourcing</a>

    </li>
                        <li>
    <a href="/event-sourcing/repositories.html">Working with Repositories</a>

    </li>
                        <li>
    <a href="/event-sourcing/snapshots.html">Snapshots</a>

    </li>
                        <li>
    <a href="/event-sourcing/inheritance.html">Inheritance with Aggregate Roots</a>

    </li>
                        <li>
    <a href="/event-sourcing/interop_factories.html">Interop Factories</a>

    </li>
                        <li>
    <a href="/event-sourcing/migration.html">Migration from v4 to v5</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/service-bus/">Service Bus</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/service-bus/intro.html">PSB - ProophServiceBus</a>

    </li>
                        <li>
    <a href="/service-bus/overview.html">PSB Overview</a>

    </li>
                        <li>
    <a href="/service-bus/message_bus.html">Message Buses</a>

    </li>
                        <li>
    <a href="/service-bus/plugins.html">PSB Plugins</a>

    </li>
                        <li>
    <a href="/service-bus/async_message_producer.html">Async Message Producer</a>

    </li>
                        <li>
    <a href="/service-bus/factories.html">Interop + Factories</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/event-store/">Event Store</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/event-store/intro.html">Prooph Event Store</a>

    </li>
                        <li>
    <a href="/event-store/event_store.html">Prooph Event Store</a>

    </li>
                        <li>
    <a href="/event-store/projections.html">Projections</a>

    </li>
                        <li>
    <a href="/event-store/upcasting.html">Upcasting</a>

    </li>
                        <li>
    <a href="/event-store/interop_factories.html">Interop Factories</a>

    </li>
                        <li>
    <a href="/event-store/migration.html">Migration from v6 to v7</a>

    </li>
            </ul>

    </li>
            </ul>

        </div>
    </div>
</nav>
</header>
<div class="container">
    <ol class="breadcrumb">
                        <li><a href="/">prooph components documentation</a></li>
                                <li><a href="/tutorial/">Tutorial</a></li>
                                <li class="active">Event Sourcing Basics</li>
            </ol>
    <div class="row">

                <div class="col-md-3">
            <nav class="nav-left hidden-xs hidden-sm" id="sideNav">
    <ul class="nav nav-stacked" data-spy="affix" data-offset-top="59" role="tablist">
                                <li>
                <a href="#1-3" title="Event&#x20;Sourcing&#x20;Basics">Event Sourcing Basics</a>
            </li>
                                <li>
                <a href="#1-3-1" title="Thinking&#x20;in&#x20;Events">Thinking in Events</a>
            </li>
                                <li>
                <a href="#1-3-2" title="Defining&#x20;Events">Defining Events</a>
            </li>
                                <li>
                <a href="#1-3-3" title="Event&#x20;Sourced&#x20;Aggregates">Event Sourced Aggregates</a>
            </li>
                                <li>
                <a href="#1-3-4" title="Related&#x20;reads">Related reads</a>
            </li>
            </ul>
</nav>
        </div>
                <div class="col-md-9">
<div id="section-main"><h1 id="1-3">Event Sourcing Basics</h1>
<p>Event Sourcing focuses on business processes. The reason is simple. Every write operation in a domain model causes
a state change. When using Event Sourcing those state changes are described by domain events. For example if an order gets payed
this is a state change (company gets $$$) and we can describe it with an event using past tense: <strong>OrderPayed</strong>.
We simply do that for all state changes. What we get is a series of domain events¹.</p>
<p><img src="/tutorial/img/order_stream.png" alt="Order Stream"></p>
<p><strong>Events happen one after another. They tell us a story about a business process handled by the application.</strong></p>
<h2 id="1-3-1">Thinking in Events</h2>
<p>The previous page "Why Event Sourcing" made a point about database driven designs and how Event Sourcing differs from that.
In Event Sourcing we start with thinking in events.</p>
<p>Every coding tutorial needs a playground. Ours is an eCommerce domain and our first job is to implement a shopping basket.
Business tells us that customers can browse an online shop frontend and add available products to their basket.
The customers don't need to be signed in so their basket is assigned to a shopping session until checkout.
So far, so good. But the business wants us to implement realtime stock updates.
While browsing the online shop customers should see constantly updated information about how many other customers
have the same products in their basket: "<em>5 other customers want to buy the same product at the minute</em>".
If one customer performs a checkout stock of the product should be reduced immediately along with a notification:
"<em>Product {name} was bought by customer from {localization} {time span} ago</em>".</p>
<p>Here is a simplified result of the event storming² session:</p>
<p><img src="/tutorial/img/shopping_session_event_storming.png" alt="Shopping Session Event Storming"></p>
<p>As you can see we have a variety of different events. We not only have events that are caused by the customer while
interacting with their shopping basket but also events caused by changes in foreign shopping sessions. We even have
two "error events" defined: <em>QuantityStockConflictDetected, ShoppingSessionTimedOut</em>.</p>
<h2 id="1-3-2">Defining Events</h2>
<p>In the tutorial introduction we already took a look at prooph messages and created our first command. Events are created in a
similar fashion. In fact they are just another type of message. Hence, each prooph event is an implementation of <code>Prooph\Common\Messaging\Message</code>.</p>
<p>You still have the <code>prooph_tutorial</code> project at hand with <code>prooph/common</code> installed via composer? If not, please go back to
the <a href="introduction.html">introduction</a> and follow the steps there before continuing with the Event Sourcing tutorial.</p>
<p>We need a project structure for our shopping basket implementation.</p>
<pre><code>|_ Basket
| |_ scripts           
| |_ src
| | |_ Infrastructure
| | | |_ Prooph
| | |_ Model
| | | |_ Basket
| | | |_ Command
| | | |_ Event
| | | |_ ERP
| | | |_ Exception
| | |_ Projection
| |   |_ Query
| |_ tests
|    |_Model
|_ scripts
</code></pre>
<p>Run the following command in the <code>prooph_tutorial</code> directory.</p>
<pre><code class="language-bash">$ mkdir -p ./Basket/src/Infrastruture/Prooph \
    ./Basket/src/Model/Command/ \
   ./Basket/src/Model/Event/ \
   ./Basket/src/Model/Basket/ \
   ./Basket/src/Model/ERP/ \
   ./Basket/src/Model/Exception/ \
   ./Basket/src/Projection/Query \
   ./Basket/tests/Model \
   ./scripts
</code></pre>
<p>Replace <code>composer.json</code> with this version and run <code>composer update</code>:</p>
<pre><code class="language-json">{
    "autoload": {
        "psr-4": {"App\\Basket\\": "Basket/src/"}
    },
    "autoload-dev": {
        "psr-4": {"App\\BasketTest\\": "Basket/tests/"}
    },
    "require": {
        "prooph/common": "^4.1",
        "prooph/event-sourcing": "^5.2"
    },
    "require-dev": {
        "phpunit/phpunit": "^6.0"
    }
}
</code></pre>
<p>We just configured composer's autoloader to use the namespace <code>App\Basket</code>  for our <code>Basket</code> context and the appropriate
test namespace <code>Àpp\BasketTest</code>.
We've also added the package <code>prooph/event-sourcing</code> to the list of dependencies and told composer to install <code>phpunit/phpunit</code>
when we're in dev mode.</p>
<p>You can guess that <code>prooph/event-sourcing</code> provides the basic implementation needed to develop an event sourced domain model.</p>
<p>Now it's time to define our first domain event. We place all events in <code>./Basket/src/Model/Event/</code></p>
<p><em>File: ./Basket/src/Model/Event/ShoppingSessionStarted.php</em></p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Basket\Model\Event;

use App\Basket\Model\Basket\BasketId;
use App\Basket\Model\Basket\ShoppingSession;
use Prooph\EventSourcing\AggregateChanged;

final class ShoppingSessionStarted extends AggregateChanged
{
    public function basketId(): BasketId
    {
        //Note: Internally, we work with scalar types, but the getter returns the value object
        return BasketId::fromString($this-&gt;aggregateId());
    }

    public function shoppingSession(): ShoppingSession
    {
        //Same here, return domain specific value object
        return ShoppingSession::fromString($this-&gt;payload['shopping_session']);
    }
}

</code></pre>
<p>What we do here is extending the base event class <code>AggregateChanged</code> from the <code>prooph/event-sourcing</code> package.
More about aggregates in a minute. First let's have a look at what the base event class has to offer:</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace Prooph\EventSourcing;

use Assert\Assertion;
use Prooph\Common\Messaging\DomainEvent;

class AggregateChanged extends DomainEvent
{
    /**
     * @var array
     */
    protected $payload = [];

    public static function occur(string $aggregateId, array $payload = []): self
    {
        return new static($aggregateId, $payload);
    }
    //...
}
</code></pre>
<p><code>AggregateChanged</code> extends <code>Prooph\Common\Messaging\DomainEvent</code>. That's the link back to <code>prooph/common</code> and turns
all events into prooph messages. Keep that in mind as this is an important information needed later when we want to
send events around.</p>
<p>We also see a static factory method called <code>occur</code> that takes an <code>$aggregateId</code> and <code>$payload</code> as arguments.
The <code>$aggregateId</code> is a reference to the corresponding aggregate. <strong>Every domain event belongs to exactly one aggregate</strong>.</p>
<h2 id="1-3-3">Event Sourced Aggregates</h2>
<p>Event Sourced Aggregates are Domain-Driven Aggregates - units of consistency.
They protect invariants. This basically means that an aggregate makes sure that it can transition to a new state.
Different business rules can permit or prevent those state transitions. The aggregate has to enforce the business rules.</p>
<p>In our case we need to consider following business rules:</p>
<ul>
<li>
<em>A shopping session is started with an empty basket.</em>
</li>
<li>
<em>Each shopping session gets its own basket assigned.</em>
</li>
<li>
<em>A product can only be added to a basket if at least one product is available in stock.</em>
</li>
<li>
<em>Product quantity in a basket must not be higher than available stock.</em>
</li>
<li>
<em>If stock is reduced by a checkout, product quantity in currently active baskets need to be checked and conflicts resolved.</em>
</li>
<li>
<em>If product quantity in a basket is reduced to zero or less the product is removed from the basket.</em>
</li>
<li>
<em>A checkout can only be made if no unresolved quantity-stock-conflicts exist for the basket.</em>
</li>
</ul>
<p>Looking at the rules we can identify a repeating pattern. Every rule includes a state check against a basket and/or describes
a state transition of a basket. With our current understanding of the domain we're good to go with a <code>Basket</code> aggregate that
enforces the business rules described above.</p>
<p>Even if we name our aggregate only <code>Basket</code> you can think of it like it would be named <code>BasketProcess</code>.
We don't do it that way because it does not reflect the Ubiquitous Language³ which we draw off from the language used by the business.
However, when implementing Event Sourcing you can always keep that <code>Process</code> suffix in mind.</p>
<p>Recap: Every state transition is described by an event. Events happen one after another. They tell us a story about
a business <strong>process</strong>. Indeed, an aggregate is a process consisting of multiple steps happening in a sequence.
Whereby, each next step is validated by the aggregate upfront using current state:</p>
<p><em>A checkout can only be made if no unresolved quantity-stock-conflicts exist for the basket.</em></p>
<p>Effective Aggregate Design¹¹ is possibly the hardest part of a well crafted domain model. And it evolves over time so
be prepared to constantly refactor previous design decisions. Thinking of aggregates as processes and model them in an event
sourced fashion can help a lot, but it remains a task that needs practice. So don't worry if your first attempts end up
being unpractical. You will get better. <strong>Thinking in events and processes is the key.</strong></p>
<p>Let's add the <code>Basket</code> aggregate now.</p>
<p><em>File: ./Basket/src/Model/Basket.php</em></p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Basket\Model;

use Prooph\EventSourcing\AggregateChanged;
use Prooph\EventSourcing\AggregateRoot;

final class Basket extends AggregateRoot
{
    protected function aggregateId(): string
    {
        // TODO: Implement aggregateId() method.
    }

    /**
     * Apply given event
     */
    protected function apply(AggregateChanged $event): void
    {
        // TODO: Implement apply() method.
    }
}
</code></pre>
<p>Our <code>Basket</code> class extends <code>Prooph\EventSourcing\AggregateRoot</code>. This is the base class for all event sourced aggregates.
Later we'll also look at an alternative approach using traits instead of extending a prooph class but the
version shown here is easier to understand and helps us with the first steps. <code>AggregateRoot</code> is an abstract class and asks us to implement
two methods <code>aggregateId()</code> which should provide the string representation of the globally unique identifier of the aggregate
and an <code>apply()</code> method.</p>
<p>The <code>apply()</code> method is best explained with an example so let us dive into the implementation. Each aggregate has a
lifecycle. To start such a lifecycle we need to create the aggregate. But prooph's <code>AggregateRoot</code> does not allow to use
the class constructor as public method. Instead we're asked to use a so called <strong>named constructor</strong> aka static factory method.</p>
<p><em>File: ./Basket/src/Model/Basket.php</em></p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Basket\Model;

use App\Basket\Model\Event\ShoppingSessionStarted;
use App\Basket\Model\Basket\BasketId;
use App\Basket\Model\Basket\ShoppingSession;
use Prooph\EventSourcing\AggregateChanged;
use Prooph\EventSourcing\AggregateRoot;

final class Basket extends AggregateRoot
{
    public static function startShoppingSession(
        ShoppingSession $shoppingSession, 
        BasketId $basketId)
    {
        //Start new aggregate lifecycle by creating an "empty" instance
        $self = new self();
        
        //Record the very first domain event of the new aggregate
        //Note: we don't pass the value objects directly to the event but use their
        //primitive counterparts. This makes it much easier to work with the events later
        //and we don't need complex serializers when storing events.
        $self-&gt;recordThat(ShoppingSessionStarted::occur($basketId-&gt;toString(), [
            'shopping_session' =&gt; $shoppingSession-&gt;toString()
        ]));
        
        //Return the new aggregate
        return $self;
    }

    protected function aggregateId(): string
    {
        // TODO: Implement aggregateId() method.
    }

    /**
     * Apply given event
     */
    protected function apply(AggregateChanged $event): void
    {
        // TODO: Implement apply() method.
    }
}

</code></pre>
<p>A meaningful named constructor using the Ubiquitous Language is a great way to let the code document itself.
The <code>Basket</code> aggregate requires a <code>ShoppingSession</code> and a <code>BasketId</code> to start the shopping session.
Both are value objects that we're going to add next.</p>
<p><em>Note: BasketId becomes the identifier of the aggregate but it is created outside of the aggregate. That's a common pattern in
a CQRS system. For example the frontend can create a BasketId using a JavaScript UUID library and send the BasketId to
the backend. Remember from the introduction chapter: Handling a command has no response other than success or failure. In case
of success the frontend can use the BasketId to fetch state of the Basket from a read model. Later in the tutorial we'll
see that in action. For now just keep in mind that aggregate ids are created by the client or application layer
if a CQRS architecture is used.</em></p>
<p><em>File: ./Basket/src/Model/Basket/ShoppingSession.php</em></p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Basket\Model\Basket;

final class ShoppingSession
{
    private $shoppingSession;

    public static function fromString(string $shoppingSession): self
    {
        return new self($shoppingSession);
    }

    private function __construct(string $shoppingSession)
    {
        if($shoppingSession === '') {
            throw new \InvalidArgumentException("Shopping session must not be an empty string");
        }

        $this-&gt;shoppingSession = $shoppingSession;
    }

    public function toString(): string
    {
        return $this-&gt;shoppingSession;
    }

    public function equals($other): bool
    {
        if(!$other instanceof self) {
            return false;
        }

        return $this-&gt;shoppingSession === $other-&gt;shoppingSession;
    }

    public function __toString(): string
    {
        return $this-&gt;shoppingSession;
    }
}

</code></pre>
<p><em>File: ./Basket/src/Model/Basket/BasketId.php</em></p>
<pre><code class="language-php">&lt;?php
declare(strict_types=1);

namespace App\Basket\Model\Basket;

use Ramsey\Uuid\Uuid;

final class BasketId
{
    private $basketId;

    public static function fromString(string $basketId): self
    {
        return new self($basketId);
    }

    private function __construct(string $basketId)
    {
        if(!Uuid::isValid($basketId)) {
            throw new \InvalidArgumentException("Given basket id is not a valid UUID. Got " . $basketId);
        }

        $this-&gt;basketId = $basketId;
    }

    public function toString(): string
    {
        return $this-&gt;basketId;
    }

    public function equals($other): bool
    {
        if(!$other instanceof self) {
            return false;
        }

        return $this-&gt;basketId === $other-&gt;basketId;
    }

    public function __toString(): string
    {
        return $this-&gt;basketId;
    }
}

</code></pre>
<p>Recap: We used a named constructor to create the <code>Basket</code> aggregate. The named constructor defines the requirements needed
to start a shopping session, namely the <code>ShoppingSession</code> and <code>BasketId</code>. Instead of setting those value objects as properties
in the <code>Basket</code> aggregate we <strong>record</strong> the first domain event <code>ShoppingSessionStarted</code> of the aggregate.</p>
<p>Now the <code>apply()</code> method comes into play. Our <code>Basket</code> aggregate will have many more methods later to deal with all things
happening during a shopping session. And in those methods we will often need the current <strong>state</strong> of the aggregate to
<strong>protect invariants</strong>. To get access to the state we need to <code>apply()</code> recorded domain events in the exact same order as
they were recorded. Prooph's <code>ÀggregateRoot</code> takes care of the latter but it does not know <strong>how</strong> a domain event should
be applied. Hence, we need to take over that task.</p>
<p><em>File: ./Basket/src/Model/Basket.php</em></p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Basket\Model;

use App\Basket\Model\Event\ShoppingSessionStarted;
use App\Basket\Model\Basket\BasketId;
use App\Basket\Model\Basket\ShoppingSession;
use Prooph\EventSourcing\AggregateChanged;
use Prooph\EventSourcing\AggregateRoot;

final class Basket extends AggregateRoot
{
    /**
     * @var BasketId
     */
    private $basketId;

    /**
     * @var ShoppingSession
     */
    private $shoppingSession;

    public static function startShoppingSession(ShoppingSession $shoppingSession, BasketId $basketId)
    {
        $self = new self();
        $self-&gt;recordThat(ShoppingSessionStarted::occur($basketId-&gt;toString(), [
            'shopping_session' =&gt; $shoppingSession-&gt;toString()
        ]));
        return $self;
    }

    protected function aggregateId(): string
    {
        // TODO: Implement aggregateId() method.
    }

    /**
     * Apply given event
     */
    protected function apply(AggregateChanged $event): void
    {
        //A simple switch by event name is the fastest way,
        //but you're free to split things up here and have for example methods like
        //private function whenShoppingSessionStarted()
        //To delegate work to them and keep the apply method lean 
        switch ($event-&gt;messageName()) {
            case ShoppingSessionStarted::class:
                /** @var $event ShoppingSessionStarted */
                
                $this-&gt;basketId = $event-&gt;basketId();
                $this-&gt;shoppingSession = $event-&gt;shoppingSession();
                break;
        }
    }
}

</code></pre>
<p>Now that we have access to the current state we can finally implement the <code>aggregateId()</code> method to fulfill the contract
defined by prooph's <code>AggregateRoot</code> class.</p>
<p><em>File: ./Basket/src/Model/Basket.php</em></p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Basket\Model;

//...

final class Basket extends AggregateRoot
{
    /**
     * @var BasketId
     */
    private $basketId;

    /**
     * @var ShoppingSession
     */
    private $shoppingSession;

    public static function startShoppingSession(ShoppingSession $shoppingSession, BasketId $basketId)
    {
        //...
    }

    protected function aggregateId(): string
    {
        //Return string representation of the globally unique identifier of the aggregate
        return $this-&gt;basketId-&gt;toString();
    }

    /**
     * Apply given event
     */
    protected function apply(AggregateChanged $event): void
    {
        //...
    }
}

</code></pre>
<p>Ok, that are the basics of Event Sourcing. Many new things to learn, right? But don't worry. You'll get used to it while
we look at some more aspects of Event Sourcing. In the next part we will look at testing event sourced aggregates
which is super easy when you have a clean and decoupled domain model.</p>
<p><em>Advise: Revisit the basics part whenever you feel lost. Event Sourcing is really simple once you understand it.
In the section below you can find links to related blog posts. But before you follow them take a break and let
the basics sink in. You can read the posts later when you feel more comfortable with Event Sourcing. Don't overload your
head with too much information at a time.</em></p>
<h2 id="1-3-4">Related reads</h2>
<ul>
<li>
<a href="http://verraes.net/2014/11/domain-events/">Domain Events - Mathias Verraes</a>¹</li>
<li>
<a href="http://ziobrando.blogspot.de/2013/11/introducing-event-storming.html">What is EventStorming - Alberto Brandolini</a>²</li>
<li>
<a href="https://martinfowler.com/bliki/UbiquitousLanguage.html">Ubiquitous Language - Martin Fowler</a>³</li>
<li>
<a href="https://vaughnvernon.co/?p=838">Effective Aggregate Design - Vaughn Vernon</a>¹¹</li>
</ul>
</div>        </div>
    </div>
</div>

<footer>
    <div class="links">
        <div class="container">
            <div class="row">
                <div class="prev col-xs-6">
                                            <a href="/tutorial/why_event_sourcing.html">Previous</a>                                    </div>
                <div class="next col-xs-6">
                                            <a href="/tutorial/testing_aggregates.html">Next</a>                                    </div>
            </div>
        </div>
    </div>
    <div id="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p>Powered by <a href="https://github.com/tobiju/bookdown-bootswatch-templates" title="Visit project to generate your own docs">Bookdown Bootswatch Templates</a>.</p>
                </div>
            </div>
        </div>
    </div>
</footer>
</div>
<a href="https://github.com/prooph/proophessor"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
        integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/0.6.0/lunr.min.js"></script>
<script src="http://bartaz.github.io/sandbox.js/jquery.highlight.js"></script>
<script src="https://tobiju.github.io/share/prismjs/main.js"></script>
<script src="https://tobiju.github.io/share/prismjs/prism.js"></script>
<script type="text/javascript">

    function Search() {
        this.store = {};
        this.index = lunr(function () {
            this.ref('id');
            this.field('title', {boost: 10});
            this.field('content');
        });
        this.searchResults = $('.js-search-results').addClass('list-search-results');
    }

    Search.prototype = {
        constructor: Search,
        init: function () {
            this.createIndex();
            this.bindEvents();
        },
        createIndex: function () {
            var $this = this,
                indexFilePath = $('.js-search-input').data('roothref') + 'index.json';

            $.getJSON(indexFilePath, function (data) {
                $.each(data, function (key, item) {
                    $this.index.add({
                        id: item.id,
                        title: item.title,
                        content: item.content
                    });

                    $this.store[item.id] = {
                        href: item.id,
                        title: item.title,
                        content: item.content
                    }
                });
            });
        },
        bindEvents: function () {
            var $this = this;

            $('html')
                .on('click', function (event) {
                    $this.close($(this), event);
                });

            $('.js-search-input, .js-search-results')
                .on('click', function (event) {
                    $this.click($(this), event);
                });

            $('.js-search-input')
                .on('focus', function (event) {
                    $this.focus($(this), event);
                })
                .on('keyup', function (event) {
                    $this.search($(this), event)
                })
                .on('keydown', function (event) {
                    if ($('.js-search-results ul').is(':visible')){
                        $this.navigation($(this), event)
                    }
                })
        },
        click: function (element, event) {
            event.stopPropagation();
        },
        focus: function (element, event) {
            this.searchInputWidth = element.css('width');
            element.animate({
                'width': 600
            }, 500);
            $('#js-navbar-collapse > ul').fadeOut();
        },
        close: function (element, event) {
            var $this = this;

            $('.js-search-results').hide();
            $('.js-search-input').animate({
                'width': $this.searchInputWidth
            }, 500);
            $('#js-navbar-collapse > ul').fadeIn();
        },
        search: function (element, event) {
            var $this = this;

            if (event.keyCode == 13 || event.keyCode == 38 || event.keyCode == 40) {
                return;
            }

            var query = element.val(),
                results = $this.index.search(query);

            if (!results.length) {
                $this.searchResults.empty();
                return;
            }

            var resultsList = results.reduce(function (ul, result) {
                var item = $this.store[result.ref];
                var title = $('<b>').text(item.title);

                var cropText = $this.cropText(item.content, query);
                if (cropText.length === 0) {
                    cropText = $('<p>').html(item.content.substring(0, 120) + "...");
                }
                var content = content = $('<p>').html(cropText);

                var div = $('<div>')
                    .append(title)
                    .append(content);
                var a = $('<a>').attr('href', item.href)
                    .append(div);
                var li = $('<li>')
                    .append(a);
                ul.append(li);

                return ul;
            }, $('<ul>'));

            this.searchResults.html(resultsList);

            $('.js-search-results').show();
            $(".js-search-results li:first-child").addClass('selected');
        },
        cropText: function (content, query) {
            var cropedText = '',
                re = new RegExp("\\s?(.{0,30})?" + query + ".*?\\b(.{0,30}.)?\\s?", "gi");

            $.each(content.match(re), function (key, value) {
                cropedText += '...' + value + '...';
            });

            return cropedText;
        },
        navigation: function (element, event) {
            var selected = null,
                listSelector = ".js-search-results ul",
                listItemSelector = listSelector + " li",
                selectedListItemSelector = listItemSelector + ".selected",
                selectedListItemSelectorAnchor = listItemSelector + ".selected a";

            // enter
            if (event.keyCode == 13) {
                event.preventDefault();
                this.close();
                window.location.replace($(selectedListItemSelectorAnchor).attr('href'));
            }

            // up
            if (event.keyCode == 38) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.prev().length == 0) {
                    selected.siblings().last().addClass("selected");
                } else {
                    selected.prev().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListUp(selected);
            }

            // down
            if (event.keyCode == 40) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.next().length == 0) {
                    selected.siblings().first().addClass("selected");
                } else {
                    selected.next().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListDown(selected);
            }
        },
        scrollListDown: function (element) {
            var ul = element.parent(),
                ulHeight = ul.height(),
                ulBottomPosition = ulHeight + ul.scrollTop(),
                liBottomPosition = element.position().top + element.height();

            if (liBottomPosition > ulBottomPosition) {
                ul.scrollTop(liBottomPosition - ulHeight);
            }

            if (element.is(':first-child')) {
                ul.scrollTop(0);
            }
        },
        scrollListUp: function (element) {
            var ul = element.parent(),
                ulTopPosition = ul.scrollTop(),
                liTopPosition = element.position().top;

            if (liTopPosition < ulTopPosition) {
                ul.scrollTop(element.position().top);
            }

            if (element.is(':last-child')) {
                ul.scrollTop(element.position().top - element.height());
            }
        }
    };

    $(function () {
        var search = new Search();
        search.init();
    });
</script>
</body></html>
