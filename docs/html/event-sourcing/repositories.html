
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<meta name="HandheldFriendly" content="True"/>
<title>Working with Repositories</title>
<link rel="shortcut icon" href="http://getprooph.org/images/ico/prooph-logo@0.5x.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://getprooph.org/images/ico/apple-touch-icon-144-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://getprooph.org/images/ico/apple-touch-icon-114-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://getprooph.org/images/ico/apple-touch-icon-72-precomposed.png">
<link rel="apple-touch-icon-precomposed" href="http://getprooph.org/images/ico/apple-touch-icon-57-precomposed.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@prooph_software">
<meta name="twitter:title" content="prooph components">
<meta name="twitter:description" content="Enterprise-ready CQRS and Event Sourcing packages for PHP with support for the most famous PHP web frameworks">
<meta name="twitter:image" content="http://getprooph.org/images/prooph-components-intro.png">
    <link rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/cerulean/bootstrap.min.css">
<link rel="stylesheet"
      href="https://tobiju.github.io/share/prismjs/prism-ghcolors.css"/>
<link rel="stylesheet"
      href="https://tobiju.github.io/share/prismjs/prism-linenumbers.css"/>
<style>
    body, html {
        height: 100%;
        padding-top: 36px;
        position: relative;
    }

    img {
        max-width: 100%;
    }

    code span {
        white-space: nowrap;
    }
    code span.comment {
        white-space: pre;
    }

    .highlight {
        background: #FFFF88;
    }

    .page-wrapper {
        min-height: 100%;
        padding-bottom: 170px;
        position: relative;
    }

    .box-header {
        position: relative;
    }

    /* Header Section */
    header {
        background: white;
        color: black;
        font-size: 16px;
        font-weight: 300;
    }

    h1:first-child {
        margin-top: 0;
    }

    /* anchor link will be displayed after the static top nav */
    h1:before,
    h2:before,
    h3:before,
    h4:before,
    h5:before,
    h6:before {
        display: block;
        content: " ";
        margin-top: -64px;
        height: 64px;
        visibility: hidden;
    }

    .navbar-brand {
        padding: 0;
    }

    .navbar-brand img {
        max-height: 100%;
    }

    /* Content Section */
    #content {
        margin-bottom: 17px;
        font-size: 17px;
        min-height: 200px;
    }

    .breadcrumb {
        position: relative;
        z-index: 999;
    }

    .links {
        background: #f8f8f8;
        border-top: 1px solid #e5e5e5;
        border-bottom: 1px solid #e5e5e5;
        padding: 16px 0;
    }

    .links .prev {
        text-align: left;
    }

    .links .parent {
        text-align: center;
    }

    .links .next {
        text-align: right;
    }

    /* Search */
    .form-search {
        position: absolute;
        right: 0;
        top: 0;
        z-index: 999;
    }

    @media (max-width: 767px) {
        .form-search {
            position: relative;
            margin-top: 0;
        }
    }

    .form-search .form-control {
        border: 0;
        width: 80px;
    }

    @media (max-width: 767px) {
        .form-search .form-control {
            width: 100% !important;
        }
    }

    .form-search .list-search-results {
        position: relative;
    }

    .form-search .list-search-results ul {
        background: #eee;
        border: 1px solid inherit;
        list-style: none;
        max-height: 300px;
        overflow: auto;
        padding: 0;
        position: absolute;
        width: 100%;
        z-index: 999;
    }

    .form-search .list-search-results ul li:nth-child(even) {
        background: rgba(255, 255, 255, 0.3)
    }

    .form-search .list-search-results ul li.selected {
        background: #ccc;
    }

    .form-search .list-search-results ul li a {
        display: block;
        padding: 4px 8px;
    }

    /* TOC */
    .list-toc {
        padding: 0;
    }

    .list-toc .list-group-item {
        background: 0 none;
        position: relative;
        font-weight: bold;
        padding: 0;
        margin: 0;
    }

    .list-toc li .text-number {
        padding-left: 20px;
    }
    .list-toc li li .text-number {
        padding-left: 40px;
    }
    .list-toc li li li .text-number {
        padding-left: 60px;
    }
    .list-toc li li li li .text-number {
        padding-left: 80px;
    }
    .list-toc li li li li li .text-number {
        padding-left: 100px;
    }
    .list-toc .text-number {
        padding-left: 100px;
    }

    .list-toc .list-group-item .row {
        padding: 7px 0 7px;
    }

    .list-toc .list-group-item .bbt-toc-toggle {
        display: block;
        position: absolute;
        top: 5px;
        right: 10px;
        font-weight: normal;
    }

    .list-toc .list-group-item .bbt-toc-toggle:before {
        content: "";
        display: block;
    }

    .list-toc .list-group-item .bbt-toc-toggle.collapsed:before {
        content: "";
        display: block;
    }

    .list-toc > li:nth-child(2n+1) {
        background: rgba(0, 0, 0, 0.03);
    }

    .bbt-theme-cyborg .list-toc > li:nth-child(2n+1),
    .bbt-theme-darkly .list-toc > li:nth-child(2n+1),
    .bbt-theme-slate .list-toc > li:nth-child(2n+1),
    .bbt-theme-superhero .list-toc > li:nth-child(2n+1) {
        background: rgba(255, 255, 255, 0.05);
    }

    .list-toc .list-group-item {
        border-bottom: 0 none;
        border-left: 0 none;
        border-right: 0 none;
        font-size: inherit;
    }

    .list-toc .list-group-item:first-child {
        border-top-right-radius: 0;
        border-top-left-radius: 0;
    }

    .list-toc .list-group-item:last-child {
        border-bottom-right-radius: 0;
        border-bottom-left-radius: 0;
    }

    /* Left navigation */
    .nav-left ul li a {
        padding-top: 3px;
        padding-bottom: 3px;
        border-left: 1px solid transparent;
    }

    .nav-left ul li.active a,
    .nav-left ul li a:hover {
        background: none !important;
        color: inherit;
        border-color: inherit;
    }

    .navbar-top {
        position: relative;
    }

    .affix {
        top: 60px;
    }

    .badge {
        border-radius: 4px;
        padding: 5px;
    }

    /* Footer Section */
    footer {
        color: black;
        background: white;
        width: 100%;
        position: absolute;
        bottom: 0;
    }

    footer #copyright {
        padding: 30px;
        text-align: center;
        color: #444;
    }

    footer #copyright p {
        margin: 0;
    }

    footer #copyright span a {
        color: white;
    }

    /* Top Navigation */
    @media (max-width: 767px) {
        ul.navbar-nav {
            margin: 0 -15px
        }

        ul.navbar-nav li {
            border-radius: 0;
        }

        ul.navbar-nav li ul {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 0;
            box-shadow: none;
            display: block;
            float: none;
            left: auto;
            padding: 0;
            position: static;
        }

        ul.navbar-nav li ul li a {
            padding: 8px 30px;
        }

        ul.navbar-nav li ul li ul li a {
            padding: 6px 40px;
        }
    }

    @media (min-width: 768px) {

        ul.navbar-nav li {
            display: block;
            position: relative;
            float: left;
        }

        ul.navbar-nav li ul {
            display: none;
        }

        ul.navbar-nav li a {
            display: block;
        }

        ul.navbar-nav li:hover > ul {
            display: block;
            position: absolute;
        }

        ul.navbar-nav li:hover li {
            float: none;
        }

        ul.navbar-nav ul ul {
            left: 100%;
            top: 0;
        }
    }
</style>
    <style>
    .prooph-logo {
            float: left;
            margin-left: 8px;
            margin-right: 8px;
            transition-timing-function: ease-in-out;
            transition: all 5s;
            height: 50px;
            padding: 5px;
        }

        .prooph-logo:hover {
            transition: all .7s;
            transition-timing-function: ease-out;
            transform: rotate(360deg);
        }
</style>
</head>
<body data-spy="scroll" data-target="#sideNav" data-offset="50" class="bbt-theme-cerulean">
<div class="page-wrapper">
    <header>
    
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="box-header container">
        <form class="form-search navbar-form navbar-right" role="search">
            <div class="form-group">
                <input type="text"
                       placeholder="Search"
                       class="js-search-input form-control"
                       data-roothref="/">

                <div class="js-search-results"></div>
            </div>
        </form>

        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#js-navbar-collapse" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://getprooph.org">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" class="prooph-logo">
                    <defs>
                        <style>
                            .cls-1{fill:#04a1b0;}.cls-2{fill:#26896c;}.cls-3{fill:#eeca50;}.cls-4{fill:#eb6842;}.cls-5{fill:#cc3340;}.cls-6{fill:#715671;}
                        </style>
                    </defs>
                    <title>prooph-logo</title>
                    <g id="artwork">
                        <g id="Layer_5" data-name="Layer 5">
                            <path class="cls-1"
                                  d="M57.22,17,67.84,35.43a1.77,1.77,0,0,0,1.53.89h61.25a1.77,1.77,0,0,0,1.53-.89L142.78,17a1.77,1.77,0,0,0-1.53-2.66H58.76A1.77,1.77,0,0,0,57.22,17Z"/>
                            <path class="cls-2"
                                  d="M29.54,94.68l30.63-53a1.77,1.77,0,0,0,0-1.77L49.55,21.48a1.77,1.77,0,0,0-3.07,0L5.24,92.91a1.77,1.77,0,0,0,1.53,2.66H28A1.77,1.77,0,0,0,29.54,94.68Z"/>
                            <path class="cls-3"
                                  d="M60.16,158.36l-30.63-53a1.77,1.77,0,0,0-1.53-.89H6.78a1.77,1.77,0,0,0-1.53,2.66l41.24,71.43a1.77,1.77,0,0,0,3.07,0l10.61-18.38A1.77,1.77,0,0,0,60.16,158.36Z"/>
                            <path class="cls-4"
                                  d="M130.63,163.68H69.37a1.77,1.77,0,0,0-1.53.89L57.22,183a1.77,1.77,0,0,0,1.53,2.66h82.48a1.77,1.77,0,0,0,1.53-2.66l-10.61-18.38A1.77,1.77,0,0,0,130.63,163.68Z"/>
                            <path class="cls-5"
                                  d="M170.46,105.32l-30.63,53a1.77,1.77,0,0,0,0,1.77l10.61,18.38a1.77,1.77,0,0,0,3.07,0l41.24-71.43a1.77,1.77,0,0,0-1.53-2.66H172A1.77,1.77,0,0,0,170.46,105.32Z"/>
                            <path class="cls-6"
                                  d="M139.84,41.64l30.63,53a1.77,1.77,0,0,0,1.53.89h21.23a1.77,1.77,0,0,0,1.53-2.66L153.52,21.48a1.77,1.77,0,0,0-3.07,0L139.84,39.86A1.77,1.77,0,0,0,139.84,41.64Z"/>
                        </g>
                    </g>
                </svg>
            </a>

        </div>

        <div class="collapse navbar-collapse" id="js-navbar-collapse">
            
    
    <ul class="nav navbar-nav">
                        <li>
    <a href="/tutorial/">Tutorial</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/tutorial/introduction.html">Introduction</a>

    </li>
                        <li>
    <a href="/tutorial/why_event_sourcing.html">Why Event Sourcing?</a>

    </li>
                        <li>
    <a href="/tutorial/event_sourcing_basics.html">Event Sourcing Basics</a>

    </li>
                        <li>
    <a href="/tutorial/testing_aggregates.html">Testing Aggregates</a>

    </li>
                        <li>
    <a href="/tutorial/aggregate_dependencies.html">Aggregate Dependencies</a>

    </li>
                        <li>
    <a href="/tutorial/process_managers.html">Process Managers</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/service-bus/">Service Bus</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/service-bus/intro.html">PSB - ProophServiceBus</a>

    </li>
                        <li>
    <a href="/service-bus/overview.html">PSB Overview</a>

    </li>
                        <li>
    <a href="/service-bus/message_bus.html">Message Buses</a>

    </li>
                        <li>
    <a href="/service-bus/plugins.html">PSB Plugins</a>

    </li>
                        <li>
    <a href="/service-bus/async_message_producer.html">Async Message Producer</a>

    </li>
                        <li>
    <a href="/service-bus/factories.html">Interop + Factories</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/event-store/">Event Store</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/event-store/intro.html">Prooph Event Store</a>

    </li>
                        <li>
    <a href="/event-store/event_store.html">Prooph Event Store</a>

    </li>
                        <li>
    <a href="/event-store/projections.html">Projections</a>

    </li>
                        <li>
    <a href="/event-store/upcasting.html">Upcasting</a>

    </li>
                        <li>
    <a href="/event-store/interop_factories.html">Interop Factories</a>

    </li>
                        <li>
    <a href="/event-store/migration.html">Migration from v6 to v7</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/event-sourcing/">Event Sourcing</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/event-sourcing/intro.html">ProophEventSourcing</a>

    </li>
                        <li>
    <a href="/event-sourcing/repositories.html">Working with Repositories</a>

    </li>
                        <li>
    <a href="/event-sourcing/snapshots.html">Snapshots</a>

    </li>
                        <li>
    <a href="/event-sourcing/inheritance.html">Inheritance with Aggregate Roots</a>

    </li>
                        <li>
    <a href="/event-sourcing/interop_factories.html">Interop Factories</a>

    </li>
                        <li>
    <a href="/event-sourcing/migration.html">Migration from v4 to v5</a>

    </li>
            </ul>

    </li>
            </ul>

        </div>
    </div>
</nav>
</header>
<div class="container">
    <ol class="breadcrumb">
                        <li><a href="/">prooph components documentation</a></li>
                                <li><a href="/event-sourcing/">Event Sourcing</a></li>
                                <li class="active">Working with Repositories</li>
            </ol>
    <div class="row">

                <div class="col-md-3">
            <nav class="nav-left hidden-xs hidden-sm" id="sideNav">
    <ul class="nav nav-stacked" data-spy="affix" data-offset-top="59" role="tablist">
                                <li>
                <a href="#4-2" title="Working&#x20;with&#x20;Repositories">Working with Repositorie...</a>
            </li>
                                <li>
                <a href="#4-2-1" title="Event&#x20;Sourced&#x20;Aggregates">Event Sourced Aggregates</a>
            </li>
                                <li>
                <a href="#4-2-2" title="AggregateType">AggregateType</a>
            </li>
                                <li>
                <a href="#4-2-3" title="AggregateTranslator">AggregateTranslator</a>
            </li>
                                <li>
                <a href="#4-2-4" title="Snapshot&#x20;Store">Snapshot Store</a>
            </li>
                                <li>
                <a href="#4-2-5" title="Event&#x20;Streams">Event Streams</a>
            </li>
                                <li>
                <a href="#4-2-6" title="Wiring&#x20;It&#x20;Together">Wiring It Together</a>
            </li>
                                            <li>
                <a href="#4-2-7" title="Aggregate&#x20;Type&#x20;Mapping">Aggregate Type Mapping</a>
            </li>
                                <li>
                <a href="#4-2-8" title="Loading&#x20;of&#x20;thousands&#x20;aggregates">Loading of thousands agg...</a>
            </li>
            </ul>
</nav>
        </div>
                <div class="col-md-9">
<div id="section-main"><h1 id="4-2">Working with Repositories</h1>
<p>Repositories typically connect your domain model with the persistence layer (part of the infrastructure).
Following DDD suggestions your domain model should be database agnostic.
An event store is of course some kind of database so you are likely looking for a third-party event store that gets out of your way.</p>
<p><em>The good news is:</em> <strong>You've found one!</strong></p>
<p>But you need to get familiar with the concept. So you're pleased to read this document and follow the example.
Afterwards you should be able to integrate <code>prooph/event-store</code> into your infrastructure without coupling it with your model.</p>
<h2 id="4-2-1">Event Sourced Aggregates</h2>
<p>We assume that you want to work with event sourced aggregates. If you are not sure what we are talking about
please refer to the great educational project <a href="http://buttercup-php.github.io/protects/">Buttercup.Protects</a> by Mathias Verraes.
prooph/event-store does not include base classes or traits to add event sourced capabilities to your aggregates.</p>
<p>Sounds bad? It isn't!</p>
<p>It is your job to write something like <code>Buttercup.Protects</code> for your model. Don't be lazy in this case.</p>
<p>The event store doesn't know anything about aggregates. It is just interested in <code>Prooph\Common\Messaging\Message events</code>.
These events are organized in <code>Prooph\EventStore\Stream</code>s.
A repository is responsible for extracting pending events from aggregates and putting them in the correct stream.
And the repository must also be able to load persisted events from a stream and reconstitute an aggregate.
To provide this functionality the repository makes use of various helper classes explained below.</p>
<h2 id="4-2-2">AggregateType</h2>
<p>Each repository is responsible for one <code>\Prooph\EventSourcing\Aggregate\AggregateType</code>.</p>
<h2 id="4-2-3">AggregateTranslator</h2>
<p>To achieve 100% decoupling between layers and/or contexts you can make use of translation adapters.
For prooph/event-store such a translation adapter is called a <code>Prooph\EventSourcing\Aggregate\AggregateTranslator</code>.</p>
<p>The interface requires you to implement 5 methods:</p>
<ul>
<li>extractAggregateId</li>
<li>extractAggregateVersion</li>
<li>extractPendingStreamEvents</li>
<li>reconstituteAggregateFromHistory</li>
<li>replayStreamEvents</li>
</ul>
<p>To make your life easier prooph/event-sourcing ships with a <code>\Prooph\EventSourcing\EventStoreIntegration\AggregateTranslator</code> which implements the interface.</p>
<h2 id="4-2-4">Snapshot Store</h2>
<p>A repository can be set up with a snapshot store to speed up loading of aggregates.</p>
<p>You need to install <a href="https://github.com/prooph/snapshot-store">Prooph SnapshotStore</a> and a persistable implementation of it,
like <a href="https://github.com/prooph/pdo-snapshot-store/">pdo-snapshot-store</a> or <a href="https://github.com/prooph/mongodb-snapshot-store/">mongodb-snapshot-store</a>.</p>
<h2 id="4-2-5">Event Streams</h2>
<p>An event stream can be compared with a table in a relational database (and in case of the pdo-event-store it is a table).
By default the repository puts all events of all aggregates (no matter the type) in a single stream called <strong>event_stream</strong>.
If you wish to use another name, you can pass a custom <code>Prooph\EventStore\StreamName</code> to the repository.
This is especially useful when you want to have an event stream per aggregate type, for example store all user related events
in a <code>user_stream</code>.</p>
<p>The repository can also be configured to create a new stream for each new aggregate instance. You'll need to turn the last
constructor parameter <code>oneStreamPerAggregate</code> to true to enable the mode.
If the mode is enabled the repository builds a unique stream name for each aggregate by using the <code>AggregateType</code> and append
the <code>aggregateId</code> of the aggregate. The stream name for a new <code>Acme\User</code> with id <code>123</code> would look like this: <code>Acme\User-123</code>.</p>
<p>Depending on the event store implementation used the stream name is maybe modified by the implementation to replace or removed non supported characters.
Check your event store implemtation of choice for details. You can also override <code>AggregateRepository::determineStreamName</code> to apply a custom logic
for building the stream name.</p>
<h2 id="4-2-6">Wiring It Together</h2>
<p>Best way to see a repository in action is by looking at the <code>\ProophTest\EventSourcing\Aggregate\AggregateRepositoryTest</code>.</p>
<h3 id="4-2-6-1">Set Up</h3>
<pre><code class="language-php">$this-&gt;repository = new AggregateRepository(
    $this-&gt;eventStore,
    AggregateType::fromAggregateRootClass('ProophTest\EventSourcing\Mock\User'),
    new AggregateTranslator()
);

$this-&gt;eventStore-&gt;create(new Stream(new StreamName('event_stream'), new ArrayIterator()));
</code></pre>
<p>Notice the injected dependencies! Snapshot store, stream name and stream mode are optional and not injected for all tests.
Therefore stream name defaults to <strong>event_stream</strong> and the repository appends all events to this stream.
For the test cases we also create the stream on every run. In a real application you need to do this only once.</p>
<pre><code class="language-php">/**
 * @test
 */
public function it_adds_a_new_aggregate(): void
{
    $user = User::create('John Doe', 'contact@prooph.de');

    $this-&gt;repository-&gt;saveAggregateRoot($user);

    $fetchedUser = $this-&gt;repository-&gt;getAggregateRoot(
        $user-&gt;getId()-&gt;toString()
    );

    $this-&gt;assertInstanceOf('ProophTest\EventStore\Mock\User', $fetchedUser);

    $this-&gt;assertNotSame($user, $fetchedUser);

    $this-&gt;assertEquals('John Doe', $fetchedUser-&gt;name());

    $this-&gt;assertEquals('contact@prooph.de', $fetchedUser-&gt;email());
}
</code></pre>
<p>In the first test case you can see how an aggregate (the user entity in this case) can be added to the repository.</p>
<pre><code class="language-php">/**
 * @test
 */
public function it_tracks_changes_of_aggregate(): void
{
    $user = User::create('John Doe', 'contact@prooph.de');

    $this-&gt;repository-&gt;saveAggregateRoot($user);

    $fetchedUser = $this-&gt;repository-&gt;getAggregateRoot(
        $user-&gt;getId()-&gt;toString()
    );

    $this-&gt;assertNotSame($user, $fetchedUser);

    $fetchedUser-&gt;changeName('Max Mustermann');
    
    $this-&gt;repository-&gt;saveAggregateRoot($fetchedUser);

    $fetchedUser2 = $this-&gt;repository-&gt;getAggregateRoot(
        $user-&gt;getId()-&gt;toString()
    );

    $this-&gt;assertNotSame($fetchedUser, $fetchedUser2);

    $this-&gt;assertEquals('Max Mustermann', $fetchedUser2-&gt;name());
}
</code></pre>
<p>Here we first add the user, then load it with the help of the repository and finally we change the user entity.
The change causes a <code>UserNameChanged</code> event.</p>
<p><strong>Note</strong> the identity map is cleared after each transaction commit. You may notice the <code>assertNotSame</code> checks in the test.
The repository keeps an aggregate only in memory as long as the transaction is active. Otherwise multiple long-running
processes dealing with the same aggregate would run into concurrency issues very fast.</p>
<p>The test case has some more tests including snapshot usage and working with different stream names / strategies.
Just browse through the test methods for details.</p>
<h2 id="4-2-7">Aggregate Type Mapping</h2>
<p>It's possible to map an aggregate type <code>user</code> to an aggregate root class like <code>My\Model\User</code>. To do that, add the
aggregate type mapping to your repository and use the provided aggregate type. The aggregate type mapping is implemented
in the AggregateType class like this:</p>
<pre><code class="language-php">$aggregateType = AggregateType::fromMapping(['user' =&gt; MyUser::class]);
</code></pre>
<p>Example configuration:</p>
<pre><code class="language-php">[
    'prooph' =&gt; [
        'event_sourcing' =&gt; [
            'aggregate_repository' =&gt; [
                'user_repository' =&gt; [
                    'repository_class' =&gt; MyUserRepository::class,
                    'aggregate_type' =&gt; [
                        'user' =&gt; MyUser::class, // &lt;- custom name to class mapping 
                    ],
                    'aggregate_translator' =&gt; 'user_translator',
                ],
            ],
        ],
    ],
]
</code></pre>
<h2 id="4-2-8">Loading of thousands aggregates</h2>
<p>If you need to load thousands of aggregates for reading only, your memory can be exhausted, because the
<code>AggregateRepository</code> uses an identity map. So every loaded aggregate is stored there, unless a commit is executed. If
you have a read only process, you should consider to clear the identity map at some time. This can be done by calling
<code>clearIdentityMap()</code>.</p>
<pre><code class="language-php">$thousandsOfAggregateIds = [ // lots of ids here ];
$number = 0;

foreach ($thousandsOfAggregateIds as $aggregateId) {
    $aggregate = $this-&gt;repository-&gt;getAggregateRoot($aggregateId);
    $number++;

    // do something with the aggregate data e.g. build read model

    // clear on every 500th aggregate
    if (0 === $number % 500) {
        $this-&gt;repository-&gt;clearIdentityMap();
    }
}
</code></pre>
</div>        </div>
    </div>
</div>

<footer>
    <div class="links">
        <div class="container">
            <div class="row">
                <div class="prev col-xs-6">
                                            <a href="/event-sourcing/intro.html">Previous</a>                                    </div>
                <div class="next col-xs-6">
                                            <a href="/event-sourcing/snapshots.html">Next</a>                                    </div>
            </div>
        </div>
    </div>
    <div id="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p>Powered by <a href="https://github.com/tobiju/bookdown-bootswatch-templates" title="Visit project to generate your own docs">Bookdown Bootswatch Templates</a>.</p>
                </div>
            </div>
        </div>
    </div>
</footer>
</div>
<a href="https://github.com/prooph/proophessor"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
        integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/0.6.0/lunr.min.js"></script>
<script src="http://bartaz.github.io/sandbox.js/jquery.highlight.js"></script>
<script src="https://tobiju.github.io/share/prismjs/main.js"></script>
<script src="https://tobiju.github.io/share/prismjs/prism.js"></script>
<script type="text/javascript">

    function Search() {
        this.store = {};
        this.index = lunr(function () {
            this.ref('id');
            this.field('title', {boost: 10});
            this.field('content');
        });
        this.searchResults = $('.js-search-results').addClass('list-search-results');
    }

    Search.prototype = {
        constructor: Search,
        init: function () {
            this.createIndex();
            this.bindEvents();
        },
        createIndex: function () {
            var $this = this,
                indexFilePath = $('.js-search-input').data('roothref') + 'index.json';

            $.getJSON(indexFilePath, function (data) {
                $.each(data, function (key, item) {
                    $this.index.add({
                        id: item.id,
                        title: item.title,
                        content: item.content
                    });

                    $this.store[item.id] = {
                        href: item.id,
                        title: item.title,
                        content: item.content
                    }
                });
            });
        },
        bindEvents: function () {
            var $this = this;

            $('html')
                .on('click', function (event) {
                    $this.close($(this), event);
                });

            $('.js-search-input, .js-search-results')
                .on('click', function (event) {
                    $this.click($(this), event);
                });

            $('.js-search-input')
                .on('focus', function (event) {
                    $this.focus($(this), event);
                })
                .on('keyup', function (event) {
                    $this.search($(this), event)
                })
                .on('keydown', function (event) {
                    if ($('.js-search-results ul').is(':visible')){
                        $this.navigation($(this), event)
                    }
                })
        },
        click: function (element, event) {
            event.stopPropagation();
        },
        focus: function (element, event) {
            this.searchInputWidth = element.css('width');
            element.animate({
                'width': 600
            }, 500);
            $('#js-navbar-collapse > ul').fadeOut();
        },
        close: function (element, event) {
            var $this = this;

            $('.js-search-results').hide();
            $('.js-search-input').animate({
                'width': $this.searchInputWidth
            }, 500);
            $('#js-navbar-collapse > ul').fadeIn();
        },
        search: function (element, event) {
            var $this = this;

            if (event.keyCode == 13 || event.keyCode == 38 || event.keyCode == 40) {
                return;
            }

            var query = element.val(),
                results = $this.index.search(query);

            if (!results.length) {
                $this.searchResults.empty();
                return;
            }

            var resultsList = results.reduce(function (ul, result) {
                var item = $this.store[result.ref];
                var title = $('<b>').text(item.title);

                var cropText = $this.cropText(item.content, query);
                if (cropText.length === 0) {
                    cropText = $('<p>').html(item.content.substring(0, 120) + "...");
                }
                var content = content = $('<p>').html(cropText);

                var div = $('<div>')
                    .append(title)
                    .append(content);
                var a = $('<a>').attr('href', item.href)
                    .append(div);
                var li = $('<li>')
                    .append(a);
                ul.append(li);

                return ul;
            }, $('<ul>'));

            this.searchResults.html(resultsList);

            $('.js-search-results').show();
            $(".js-search-results li:first-child").addClass('selected');
        },
        cropText: function (content, query) {
            var cropedText = '',
                re = new RegExp("\\s?(.{0,30})?" + query + ".*?\\b(.{0,30}.)?\\s?", "gi");

            $.each(content.match(re), function (key, value) {
                cropedText += '...' + value + '...';
            });

            return cropedText;
        },
        navigation: function (element, event) {
            var selected = null,
                listSelector = ".js-search-results ul",
                listItemSelector = listSelector + " li",
                selectedListItemSelector = listItemSelector + ".selected",
                selectedListItemSelectorAnchor = listItemSelector + ".selected a";

            // enter
            if (event.keyCode == 13) {
                event.preventDefault();
                this.close();
                window.location.replace($(selectedListItemSelectorAnchor).attr('href'));
            }

            // up
            if (event.keyCode == 38) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.prev().length == 0) {
                    selected.siblings().last().addClass("selected");
                } else {
                    selected.prev().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListUp(selected);
            }

            // down
            if (event.keyCode == 40) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.next().length == 0) {
                    selected.siblings().first().addClass("selected");
                } else {
                    selected.next().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListDown(selected);
            }
        },
        scrollListDown: function (element) {
            var ul = element.parent(),
                ulHeight = ul.height(),
                ulBottomPosition = ulHeight + ul.scrollTop(),
                liBottomPosition = element.position().top + element.height();

            if (liBottomPosition > ulBottomPosition) {
                ul.scrollTop(liBottomPosition - ulHeight);
            }

            if (element.is(':first-child')) {
                ul.scrollTop(0);
            }
        },
        scrollListUp: function (element) {
            var ul = element.parent(),
                ulTopPosition = ul.scrollTop(),
                liTopPosition = element.position().top;

            if (liTopPosition < ulTopPosition) {
                ul.scrollTop(element.position().top);
            }

            if (element.is(':last-child')) {
                ul.scrollTop(element.position().top - element.height());
            }
        }
    };

    $(function () {
        var search = new Search();
        search.init();
    });
</script>
</body></html>
